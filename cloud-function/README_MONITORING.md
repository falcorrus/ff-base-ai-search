# Мониторинг облачной функции синхронизации

Эта система предоставляет полный набор инструментов для мониторинга и управления облачной функцией синхронизации заметок из Google Drive в Google Cloud Storage.

## Структура проекта

```
cloud-function/
├── main.py                      # Основной код облачной функции
├── enhanced_sync.py             # Улучшенная версия функции синхронизации
├── requirements.txt             # Зависимости Python
├── deploy.sh                   # Скрипт развертывания функции
├── setup_scheduler.sh          # Скрипт настройки Cloud Scheduler
├── manage_monitoring.sh        # Основной скрипт управления мониторингом
├── view_logs.sh               # Скрипт просмотра логов функции
├── view_filtered_logs.sh      # Скрипт просмотра фильтрованных логов
├── view_scheduler_logs.sh     # Скрипт просмотра логов Cloud Scheduler
├── view_metrics.sh            # Скрипт просмотра метрик функции
├── view_performance_metrics.sh # Скрипт просмотра метрик производительности
├── view_job_status.sh         # Скрипт просмотра статуса задач
├── run_monitoring.sh          # Скрипт запуска мониторинга
├── setup_monitoring.sh        # Скрипт настройки мониторинга
├── setup_monitoring_schedule.sh # Скрипт настройки расписания мониторинга
├── monitor_performance.py     # Python-скрипт мониторинга производительности
└── README.md                  # Этот файл
```

## Компоненты мониторинга

### 1. Логирование
- **Cloud Functions Logs**: Логи выполнения облачной функции
- **Cloud Scheduler Logs**: Логи запланированных задач
- **Фильтрация логов**: Просмотр логов по уровням (ERROR, WARNING, INFO) и ключевым словам

### 2. Метрики
- **Количество выполнений**: Отслеживание успешных и неуспешных выполнений
- **Время выполнения**: Мониторинг производительности функции
- **Ошибки**: Отслеживание ошибок выполнения
- **Активные инстансы**: Мониторинг масштабирования функции
- **Использование памяти**: Отслеживание потребления ресурсов

### 3. Уведомления
- **Telegram-бот**: Отправка уведомлений о результатах синхронизации
- **Уведомления об ошибках**: Мгновенное оповещение о сбоях
- **Уведомления об успехе**: Подтверждение успешного завершения синхронизации

### 4. Расписание
- **Ежедневная синхронизация**: Запуск в 23:00 по Московскому времени
- **Мониторинг производительности**: Периодическая проверка состояния функции
- **Отчеты**: Ежедневные отчеты о состоянии системы

## Использование

### Просмотр логов
```bash
# Просмотр последних логов функции
./view_logs.sh

# Просмотр фильтрованных логов
./view_filtered_logs.sh

# Просмотр логов Cloud Scheduler
./view_scheduler_logs.sh
```

### Просмотр метрик
```bash
# Просмотр метрик функции
./view_metrics.sh

# Просмотр метрик производительности
./view_performance_metrics.sh

# Просмотр статуса задач
./view_job_status.sh
```

### Управление задачами
```bash
# Запуск интерактивного менеджера мониторинга
./manage_monitoring.sh

# Настройка мониторинга
./setup_monitoring.sh

# Настройка расписания мониторинга
./setup_monitoring_schedule.sh

# Запуск мониторинга производительности
./run_monitoring.sh
```

## Уведомления в Telegram

Для получения уведомлений в Telegram необходимо:

1. Создать бота через @BotFather
2. Получить токен бота
3. Получить ID чата для отправки уведомлений
4. Установить переменные окружения:
   ```bash
   export TELEGRAM_BOT_TOKEN="your_bot_token"
   export TELEGRAM_CHAT_ID="your_chat_id"
   ```

## Расписание задач

### Основная синхронизация
- **Время**: Ежедневно в 23:00 по Московскому времени
- **Частота**: 1 раз в день
- **Цель**: Полная синхронизация заметок из Google Drive в GCS

### Мониторинг производительности
- **Время**: Каждые 6 часов
- **Частота**: 4 раза в день
- **Цель**: Проверка состояния функции и сбор метрик

### Ежедневные отчеты
- **Время**: Ежедневно в 09:00 по Московскому времени
- **Частота**: 1 раз в день
- **Цель**: Отправка сводного отчета о состоянии системы

## Безопасность

- Все ключи и токены хранятся в Secret Manager
- Используются сервисные аккаунты с минимальными необходимыми правами
- Логи не содержат конфиденциальной информации
- Доступ к системе мониторинга ограничен аутентификацией

## Стоимость

Все компоненты мониторинга находятся в пределах бесплатных лимитов Google Cloud:
- Cloud Functions: Бесплатно (в пределах лимита)
- Cloud Scheduler: Бесплатно (3 задачи в месяц)
- Cloud Monitoring: Бесплатно (основные метрики)
- Cloud Logging: Бесплатно (первые 50 ГБ в месяц)

Общая стоимость: **$0.00 в месяц**