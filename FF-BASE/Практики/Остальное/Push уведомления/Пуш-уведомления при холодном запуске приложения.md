# Инструкция по обработке пуш-уведомлений при холодном запуске приложения

от: @brozaurus

---

## Проблема

При **холодном запуске** приложения через пуш-уведомление навигация пуша может не срабатывать, если **страница-маршрутизатор** (например, главная страница с логикой определения статуса пользователя) имеет приоритет. В итоге пользователь попадает не на целевую страницу пуша, а на страницу, определённую внутренней логикой приложения.

---

## Решение

1. Параметры страницы-маршрутизатора:
    
    Добавьте на страницу, которая первой инициализируется и содержит логику маршрутизации, следующие параметры:
    
    - **`push` (Boolean):** `true`, если запуск от пуша.
        
    - **`pageName` (String):** Целевая страница для навигации.
        
    - **`id` (String, опционально):** ID для детальной страницы.
        
2. Логика навигации:
    
    На странице-маршрутизаторе, в самом начале условной логики, добавьте проверку:
    
    - **ЕСЛИ `push` = `true`:** Сразу перенаправляйте пользователя на страницу, указанную в `pageName` (используя `Custom Action` или `Maps To`), передавая `id` при необходимости.
        
    - **ИНАЧЕ (если `push` = `false`):** Выполняйте вашу стандартную логику маршрутизации (проверка статуса пользователя, перенаправление на страницу авторизации/A/B).
        

---

### Создание Custom Action для навигации по пушу (если необходимо)

Если встроенные действия FlutterFlow недостаточно гибки для вашей навигации, создайте `Custom Action`. Пример логики для такого действия:

```dart
Future navigateToPushPage(BuildContext context, String pageName, String? id) async {
  // Простая навигация, можно расширить логику в зависимости от pageName
  if (pageName == 'ProjectDetails') {
    context.pushNamed('ProjectDetails', queryParameters: {'projectId': id});
  } else if (pageName == 'Notifications') {
    context.pushNamed('Notifications');
  }
  // Добавьте другие условия для разных pageName
}
```

---

3. Настройка триггера пуш-уведомления:
    
    При отправке пуш-уведомления убедитесь, что вы передаете соответствующие параметры в его пейлоаде:
    
    - Установите `push: true`.
    - Укажите `pageName` целевой страницы (например, "ProductDetails", "Notifications" и т.д.).
    - Если требуется, включите `id` соответствующей сущности.
    
```JSON
    {
      "to": "device_token",
      "data": {
        "push": true,
        "pageName": "ProductDetails",
        "id": "product_123"
      },
      "notification": {
        "title": "Новое поступление!",
        "body": "Посмотрите наш новый продукт!"
      }
    }
```
    

---

Этот подход гарантирует, что навигация по пушу будет иметь приоритет над внутренней маршрутизацией при холодном запуске.